name: Deploy React App

# Deployment workflow for React frontend
# This triggers the base repository (fn7io/fn7) deployment pipeline

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - prod
      dockerfile:
        description: "Path to Dockerfile (default: frontend/Dockerfile)"
        required: false
        default: "frontend/Dockerfile"
        type: string
      build_context:
        description: "Docker build context (default: frontend)"
        required: false
        default: "frontend"
        type: string
      react_app_dir:
        description: "React app directory (default: frontend)"
        required: false
        default: "frontend"
        type: string
      build_target:
        description: "Docker build target (optional)"
        required: false
        type: string
      commit_sha:
        description: "Specific commit SHA to deploy (leave empty for latest)"
        required: false
        type: string
      force_rebuild:
        description: "Force rebuild even if image exists"
        required: false
        default: false
        type: boolean
      purge_cdn_cache:
        description: "Purge CDN cache after deployment"
        required: false
        default: "false"
        type: string
      fastly_CDN_ID:
        description: "Fastly CDN ID (optional)"
        required: false
        type: string
      fastly_CDN_Edge_dictionary:
        description: "Fastly CDN Edge Dictionary ID (optional)"
        required: false
        type: string
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'README.md'

permissions:
  contents: read
  actions: read

# Service name configuration - matches K8s app name
env:
  SERVICE_NAME: leads-module

jobs:
  trigger-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger base repository deployment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.FN7_PAT_trigger }}
          script: |
            // Build inputs object with only essential/non-default values
            const inputs = {
              // Required inputs
              source_repo: '${{ github.repository }}',
              service_name: '${{ env.SERVICE_NAME }}',
              // Non-default values (different from base repo defaults)
              dockerfile: '${{ github.event.inputs.dockerfile }}' || 'frontend/Dockerfile',
              build_context: '${{ github.event.inputs.build_context }}' || 'frontend',
              react_app_dir: '${{ github.event.inputs.react_app_dir }}' || 'frontend'
            };

            // Only add optional inputs if they differ from defaults or are provided
            const sourceRef = '${{ github.ref_name }}';
            if (sourceRef && sourceRef !== 'main') {
              inputs.source_ref = sourceRef;
            }

            const environment = '${{ github.event.inputs.environment }}' || 'dev';
            if (environment && environment !== 'dev') {
              inputs.environment = environment;
            }

            const commitSha = '${{ github.event.inputs.commit_sha }}';
            if (commitSha) {
              inputs.commit_sha = commitSha;
            }

            const forceRebuild = '${{ github.event.inputs.force_rebuild }}' === 'true';
            if (forceRebuild) {
              inputs.force_rebuild = true;
            }

            const purgeCdnCache = '${{ github.event.inputs.purge_cdn_cache }}';
            if (purgeCdnCache && purgeCdnCache !== 'false') {
              inputs.purge_cdn_cache = purgeCdnCache;
            }

            const fastlyCdnId = '${{ github.event.inputs.fastly_CDN_ID }}';
            if (fastlyCdnId) {
              inputs.fastly_CDN_ID = fastlyCdnId;
            }

            const fastlyCdnEdgeDict = '${{ github.event.inputs.fastly_CDN_Edge_dictionary }}';
            if (fastlyCdnEdgeDict) {
              inputs.fastly_CDN_Edge_dictionary = fastlyCdnEdgeDict;
            }

            console.log('üöÄ Triggering deployment in base repository...');
            console.log('üì¶ Service:', inputs.service_name);
            console.log('üåç Environment:', environment || 'dev (default)');
            console.log('üìÇ Source repo:', inputs.source_repo);
            console.log('üìã Inputs being sent:', Object.keys(inputs).length, 'properties');

            // Try with full path first, fallback to filename
            let response;
            try {
              response = await github.rest.actions.createWorkflowDispatch({
                owner: 'fn7io',
                repo: 'fn7',
                workflow_id: '.github/workflows/deploy-external-react.yml',
                ref: 'main',
                inputs: inputs
              });
            } catch (error) {
              console.log('‚ö†Ô∏è Error triggering workflow:', error);
              // Fallback to just filename
              console.log('‚ö†Ô∏è  Trying with filename only...');
              response = await github.rest.actions.createWorkflowDispatch({
                owner: 'fn7io',
                repo: 'fn7',
                workflow_id: 'deploy-external-react.yml',
                ref: 'main',
                inputs: inputs
              });
            }

            console.log('‚úÖ Deployment triggered successfully!');
            console.log('üîó Check status at: https://github.com/fn7io/fn7/actions');
