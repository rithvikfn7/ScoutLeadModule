name: Deploy React App

# Deployment workflow for React frontend
# This triggers the base repository (fn7io/fn7) deployment pipeline

on:
  workflow_dispatch:
    inputs:
      service_name:
        description: "Service name (must match K8s app name, auto-detected from repo name if not provided)"
        required: false
        type: string
      environment:
        description: "Deployment environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - prod
      dockerfile:
        description: "Path to Dockerfile (default: frontend/Dockerfile)"
        required: false
        default: "frontend/Dockerfile"
        type: string
      build_context:
        description: "Docker build context (default: frontend)"
        required: false
        default: "frontend"
        type: string
      react_app_dir:
        description: "React app directory (default: frontend)"
        required: false
        default: "frontend"
        type: string
      build_target:
        description: "Docker build target (optional)"
        required: false
        type: string
      commit_sha:
        description: "Specific commit SHA to deploy (leave empty for latest)"
        required: false
        type: string
      force_rebuild:
        description: "Force rebuild even if image exists"
        required: false
        default: false
        type: boolean
      purge_cdn_cache:
        description: "Purge CDN cache after deployment"
        required: false
        default: "false"
        type: string
      fastly_CDN_ID:
        description: "Fastly CDN ID (optional)"
        required: false
        type: string
      fastly_CDN_Edge_dictionary:
        description: "Fastly CDN Edge Dictionary ID (optional)"
        required: false
        type: string
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'README.md'

permissions:
  contents: read
  actions: read

jobs:
  determine-service:
    runs-on: ubuntu-latest
    outputs:
      service_name: ${{ steps.service.outputs.service_name }}
    steps:
      - name: Determine service name
        id: service
        run: |
          if [ -n "${{ github.event.inputs.service_name }}" ]; then
            SERVICE_NAME="${{ github.event.inputs.service_name }}"
          else
            # Extract service name from repository name (e.g., org/my-service -> my-service)
            SERVICE_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          fi
          echo "service_name=${SERVICE_NAME}" >> $GITHUB_OUTPUT
          echo "âœ… Service name: ${SERVICE_NAME}"

  deploy:
    needs: determine-service
    uses: fn7io/fn7/.github/workflows/reusable-deploy-external-react.yml@main
    with:
      source_repo: ${{ github.repository }}
      source_ref: ${{ github.ref_name }}
      service_name: ${{ needs.determine-service.outputs.service_name }}
      dockerfile: ${{ github.event.inputs.dockerfile || 'frontend/Dockerfile' }}
      build_context: ${{ github.event.inputs.build_context || 'frontend' }}
      react_app_dir: ${{ github.event.inputs.react_app_dir || 'frontend' }}
      build_target: ${{ github.event.inputs.build_target || '' }}
      environment: ${{ github.event.inputs.environment || 'dev' }}
      commit_sha: ${{ github.event.inputs.commit_sha || github.sha }}
      force_rebuild: ${{ github.event.inputs.force_rebuild || false }}
      purge_cdn_cache: ${{ github.event.inputs.purge_cdn_cache || 'false' }}
      fastly_CDN_ID: ${{ github.event.inputs.fastly_CDN_ID || '' }}
      fastly_CDN_Edge_dictionary: ${{ github.event.inputs.fastly_CDN_Edge_dictionary || '' }}
    secrets: inherit

