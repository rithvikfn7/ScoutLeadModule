name: Deploy Node.js Backend

# Deployment workflow for Node.js backend
# This triggers the base repository (fn7io/fn7) deployment pipeline

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - prod
      dockerfile:
        description: "Path to Dockerfile (default: backend/Dockerfile)"
        required: false
        default: "backend/Dockerfile"
        type: string
      build_context:
        description: "Docker build context (default: backend)"
        required: false
        default: "backend"
        type: string
      build_target:
        description: "Docker build target (optional)"
        required: false
        type: string
      commit_sha:
        description: "Specific commit SHA to deploy (leave empty for latest)"
        required: false
        type: string
      force_rebuild:
        description: "Force rebuild even if image exists"
        required: false
        default: false
        type: boolean
      purge_cdn_cache:
        description: "Purge CDN cache after deployment"
        required: false
        default: "false"
        type: string
      fastly_CDN_ID:
        description: "Fastly CDN ID (optional)"
        required: false
        type: string
      fastly_CDN_Edge_dictionary:
        description: "Fastly CDN Edge Dictionary ID (optional)"
        required: false
        type: string
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'README.md'

permissions:
  contents: read
  actions: read

# Service name configuration - matches K8s app name
env:
  SERVICE_NAME: leads-module-backend

jobs:
  trigger-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger base repository deployment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const dockerfile = '${{ github.event.inputs.dockerfile }}' || 'backend/Dockerfile';
            const buildContext = '${{ github.event.inputs.build_context }}' || 'backend';
            const buildTarget = '${{ github.event.inputs.build_target }}' || '';
            const environment = '${{ github.event.inputs.environment }}' || 'dev';
            const commitSha = '${{ github.event.inputs.commit_sha }}' || '${{ github.sha }}';
            const forceRebuild = '${{ github.event.inputs.force_rebuild }}' === 'true';
            const purgeCdnCache = '${{ github.event.inputs.purge_cdn_cache }}' || 'false';
            const fastlyCdnId = '${{ github.event.inputs.fastly_CDN_ID }}' || '';
            const fastlyCdnEdgeDict = '${{ github.event.inputs.fastly_CDN_Edge_dictionary }}' || '';

            const inputs = {
              source_repo: '${{ github.repository }}',
              source_ref: '${{ github.ref_name }}',
              service_name: '${{ env.SERVICE_NAME }}',
              dockerfile: dockerfile,
              build_context: buildContext,
              build_target: buildTarget,
              environment: environment,
              commit_sha: commitSha,
              force_rebuild: forceRebuild,
              purge_cdn_cache: purgeCdnCache,
              fastly_CDN_ID: fastlyCdnId,
              fastly_CDN_Edge_dictionary: fastlyCdnEdgeDict
            };

            console.log('üöÄ Triggering deployment in base repository...');
            console.log('üì¶ Service:', inputs.service_name);
            console.log('üåç Environment:', inputs.environment);
            console.log('üìÇ Source repo:', inputs.source_repo);

            const response = await github.rest.actions.createWorkflowDispatch({
              owner: 'fn7io',
              repo: 'fn7',
              workflow_id: 'deploy-external-node.yml',
              ref: 'main',
              inputs: inputs
            });

            console.log('‚úÖ Deployment triggered successfully!');
            console.log('üîó Check status at: https://github.com/fn7io/fn7/actions');
